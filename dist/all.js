function makeDownloadData(){selector_click_array.forEach(function(t){var a={},e=data.vlogs.filter(function(a){return a.v[dd.vlogID]==parseInt(t)});a.season=e[0].v[dd.season],a.vlog=e[0].v[dd.vlogNum],a.title=e[0].v[dd.title],a.date=e[0].v[dd.date],a.url="www.youtube.com"+e[0].v[dd.url],a.music=e[0].v[dd.music],a.views=e[0].v[dd.views],a.likes=e[0].v[dd.likes],a.dislikes=e[0].v[dd.dislikes],a.duration=convertSeconds(e[0].v[dd.duration]),download_data.push(a)}),downloadCSV({filename:"neistat-data.csv"})}function convertArrayOfObjectsToCSV(t){var a,e,r,n,d,o;return o=t.data||null,null!=o&&o.length?(n=t.columnDelimiter||",",d=t.lineDelimiter||"\n",r=Object.keys(o[0]),a="",a+=r.join(n),a+=d,o.forEach(function(t){e=0,r.forEach(function(r){e>0&&(a+=n),a+=t[r],e++}),a+=d}),download_data=[],a):null}function downloadCSV(t){var a,e,r,n=convertArrayOfObjectsToCSV({data:download_data});null!=n&&(e=t.filename||"export.csv",n.match(/^data:text\/csv/i)||(n="data:text/csv;charset=utf-8,"+n),a=encodeURI(n),r=document.createElement("a"),r.setAttribute("href",a),r.setAttribute("download",e),r.click())}function addEventHandlers(){$stat_button.on("click",function(){if(stat=$(this).index(),$(this).addClass("selected").siblings().removeClass("selected"),stat!==stat_before&&(initScales(),transition(),lineTransition()),3===$sortIndex){var t=$(".stat-sort");t.find(".fa").css("color","#eee"),t.find(".fa").removeClass("fa-angle-down"),t.find(".fa").addClass("fa-angle-up")}stat_before=stat}),$(".toggle-icon").on("click",function(){var t=$(this),a=t.index();toggleIcon(t,a),toggleData(t,a)});var t=$(".sort");t.on("click",function(){var a;$sortIndex=$(this).index(),1===$sortIndex?a=$(".vlog-sort"):2===$sortIndex?a=$(".city-sort"):3===$sortIndex&&(a=$(".stat-sort")),t.find(".fa").css("color","#eee"),a.find(".fa").css("color","indianred"),toggleSortArrows(a)}),$("td.selector").on("click",function(){var t=$(this),a=t.find("span");selectorClick(t,a)}),$("th.lock-icon").on("click",function(t){$thisIcon=$(this).find("span"),lockIconClick($thisIcon)}),$(".fa-info-circle").on("click",function(t){t.stopPropagation(),initAbout()}),$("#about").on("click",function(t){t.stopPropagation(),closeAbout()})}function lockIconClick(t){t.hasClass("fa-unlock-alt")?(t.removeClass("fa-unlock-alt"),t.addClass("fa-lock"),$("#line_chart").addClass("fix-line-chart"),$("#template_holder").addClass("template-holder-margin"),$("#header-fixed").addClass("header-fixed-margin"),tableOffset=1):(t.removeClass("fa-lock"),t.addClass("fa-unlock-alt"),$("#line_chart").removeClass("fix-line-chart"),$("#template_holder").removeClass("template-holder-margin"),$("#header-fixed").removeClass("header-fixed-margin"),tableOffset=185)}function selectorClick(t,a){var e,r,n;a.hasClass("fa-square-o")?(a.removeClass("fa-square-o"),a.addClass("fa-check-square-o"),a.closest(".main-row").addClass("selected-row"),e=d3.select(t[0].parentNode).datum(),r=e.v[stat],n=e.v[dd.vlogID],addMarker(r,n),selector_click_array.push(n),selector_click_array_flag=!0,$(".a-download").removeClass("freeze")):(a.removeClass("fa-check-square-o"),a.addClass("fa-square-o"),a.closest(".main-row").removeClass("selected-row"),e=d3.select(t[0].parentNode).datum(),r=e.v[stat],n=e.v[dd.vlogID],removeMarker(n))}function removeMarker(t){d3.select("#id_"+t).remove();var a=selector_click_array.indexOf(t);a>-1&&selector_click_array.splice(a,1),0===selector_click_array.length&&(selector_click_array_flag=!1,$(".a-download").addClass("freeze"))}function toggleData(t,a){5===a?d3.select(t[0].parentNode.parentNode).select(".toggle-text").html(function(t){return"<a href=http://www.youtube.com"+t.v[dd.url]+" target='_blank'><i class='fa fa-youtube-play'></i>"+t.v[dd.title]+"</a>"}):6===a?d3.select(t[0].parentNode.parentNode).select(".toggle-text").html(function(t){return"Published on "+formatDate(parseDate(t.v[dd.date]))}):7===a&&d3.select(t[0].parentNode.parentNode).select(".toggle-text").html(function(t){return"/"===t.v[dd.musicURL].charAt(0)?"Music by: <a href=http://www.soundcloud.com"+t.v[dd.musicURL]+" target='_blank'>"+t.v[dd.music]+"<i class='fa fa-angle-double-right'></i></a>":"na"===t.v[dd.musicURL]?"N/A":"Music by: <a href="+t.v[dd.musicURL]+" target='_blank'>"+t.v[dd.music]+"<i class='fa fa-angle-double-right'></i></a>"})}function toggleIcon(t,a){t.closest(".main-row").next().is(":visible")&&a===lastIconIndex?(t.closest(".main-row").next().toggle(),$("td.toggle-icon").removeClass("td-selected")):t.closest(".main-row").next().is(":visible")&&a!==lastIconIndex?($("td.toggle-icon").removeClass("td-selected"),t.addClass("td-selected")):($("tr.toggle-row").hide(),$("td.toggle-icon").removeClass("td-selected"),t.closest(".main-row").next().toggle(),t.addClass("td-selected")),lastIconIndex=a}function initAbout(){$("#about").fadeIn("fast")}function closeAbout(){$("#about").fadeOut("fast")}function transition(){d3.select(".totals-label").html(statName[stat]),d3.selectAll(".avg").style("opacity",0).html(function(t){return stat!==dd.duration?formatAbbrv(data.avg[stat]):convertSeconds(data.avg[stat])}).transition().duration(500).style("opacity",1),d3.select("#stat-total").style("opacity",0).html(function(t){return stat!==dd.duration?formatAbbrv(data.totals[stat]):convertSecondsToHours(data.totals[stat])}).transition().duration(500).style("opacity",1),d3.selectAll(".stat-name").style("opacity",0).html(statName[stat]).transition().duration(500).style("opacity",1),d3.selectAll(".main-row").select(".stat").style("opacity",0).html(function(t){return stat!==dd.duration?formatAbbrv(t.v[stat]):t.v[dd.hms]}).transition().duration(600).style("opacity",1),d3.selectAll(".main-row").select(".d1").transition().duration(1e3).styleTween("width",function(t,a,e){return d3.interpolateString(this.style.width,scale(t.v[stat])+"%")}).style("opacity",function(t){return oScale(t.v[stat])}),d3.selectAll(".d2").transition().duration(1e3).styleTween("width",function(t,a,e){return d3.interpolateString(this.style.width,scale(data.avg[stat])+"%")})}function formatLineData(){var t;for(t=0;t<data.vlogs.length;t++)chart_data.push({v:[data.vlogs[t].v[dd.views],data.vlogs[t].v[dd.likes],data.vlogs[t].v[dd.dislikes],data.vlogs[t].v[dd.duration],data.vlogs[t].v[dd.vlogID],data.vlogs[t].v[dd.date]]});$(".chart-loader").fadeOut("fast",function(){initLineChart(),d3.select("svg").transition().duration(350).style("opacity",1)})}function initLineChart(){max=d3.max(chart_data,function(t){return t.v[stat]}),width=parseInt(d3.select("#line_chart").style("width"),10),height=parseInt(d3.select("#line_chart").style("height"),10);var t=d3.select("#line_chart").append("svg").attr("width",width).attr("height",height).style("background","#1c1c1c").style("opacity",0),a=d3.scale.linear().range([margin.left,width-margin.right]).domain([chart_data[0].v[dd.chartNum],chart_data[chart_data.length-1].v[dd.chartNum]]),e=d3.time.scale().domain([parseDate(chart_data[0].v[dd.chartDate]),parseDate(chart_data[chart_data.length-1].v[dd.chartDate])]).range([margin.left,width-margin.right]),r=d3.scale.linear().range([height-margin.bottom,margin.top]).domain([0,max]),n=d3.svg.axis().scale(e).tickFormat(d3.time.format("%b %y")).outerTickSize(0).orient("bottom");t.append("g").attr("class","axis").attr("transform","translate(0,"+(height-margin.bottom)+")").call(n),lineGen=d3.svg.line().x(function(t){return a(t.v[dd.chartNum])}).y(function(t){return r(t.v[stat])}).interpolate("cardinal"),area=d3.svg.area().x(function(t){return a(t.v[dd.chartNum])}).y0(height-margin.bottom).y1(function(t){return r(t.v[stat])}).interpolate("cardinal"),t.append("path").datum(chart_data).attr("class","area").attr("fill","indianred").attr("opacity",.5).attr("shape-rendering","geometricPrecision").attr("d",area),t.append("svg:path").attr("d",lineGen(chart_data)).attr("class","main-line").attr("stroke","indianred").attr("stroke-width",2).attr("opacity",1).attr("shape-rendering","geometricPrecision").attr("fill","none"),t.append("svg:line").attr("class","average-line").attr("x1",margin.left).attr("y1",r(data.avg[stat])).attr("x2",width-margin.right).attr("y2",r(data.avg[stat])).style("stroke-width",3).style("stroke-dasharray","7, 3").style("opacity",1).style("stroke","3090c7")}function resize(){width=parseInt(d3.select("#line_chart").style("width"),10);var t=d3.scale.linear().range([margin.left,width-margin.right]).domain([chart_data[0].v[dd.chartNum],chart_data[chart_data.length-1].v[dd.chartNum]]),a=d3.time.scale().domain([parseDate(chart_data[0].v[dd.chartDate]),parseDate(chart_data[chart_data.length-1].v[dd.chartDate])]).range([margin.left,width-margin.right]),e=d3.scale.linear().range([height-margin.bottom,margin.top]).domain([0,max]),r=d3.svg.axis().scale(a).tickFormat(d3.time.format("%-m/%-d/%y")).outerTickSize(0).orient("bottom");d3.select("svg").attr("width",width),d3.select(".axis").attr("transform","translate(0,"+(height-margin.bottom)+")").call(r),lineGen=d3.svg.line().x(function(a){return t(a.v[dd.chartNum])}).y(function(t){return e(t.v[stat])}).interpolate("cardinal"),area=d3.svg.area().x(function(a){return t(a.v[dd.chartNum])}).y0(height-margin.bottom).y1(function(t){return e(t.v[stat])}).interpolate("cardinal"),d3.select("line.average-line").attr("x1",margin.left).attr("x2",width-margin.right),d3.select("path.main-line").attr("d",lineGen(chart_data)),d3.select("path.area").datum(chart_data).attr("d",area),d3.selectAll(".marker").attr("cx",function(a){return t(a.v[dd.chartNum])})}function lineTransition(){max=d3.max(chart_data,function(t){return t.v[stat]});var t=d3.scale.linear().range([margin.left,width-margin.right]).domain([chart_data[0].v[dd.chartNum],chart_data[chart_data.length-1].v[dd.chartNum]]),a=(d3.time.scale().domain([parseDate(chart_data[0].v[dd.chartDate]),parseDate(chart_data[chart_data.length-1].v[dd.chartDate])]).range([margin.left,width-margin.right]),d3.scale.linear().range([height-margin.bottom,margin.top]).domain([0,max])),e=d3.scale.linear().range([2,8]).domain([0,max]);lineGen=d3.svg.line().x(function(a){return t(a.v[dd.chartNum])}).y(function(t){return a(t.v[stat])}).interpolate("cardinal"),area=d3.svg.area().x(function(a){return t(a.v[dd.chartNum])}).y0(height-margin.bottom).y1(function(t){return a(t.v[stat])}).interpolate("cardinal"),d3.select("line.average-line").transition().duration(1e3).attr("y1",a(data.avg[stat])).attr("y2",a(data.avg[stat])),d3.select("path.main-line").transition().duration(1e3).attr("d",lineGen(chart_data)),d3.select("path.area").datum(chart_data).transition().duration(1e3).attr("d",area),d3.selectAll(".marker").transition().duration(1e3).attr("r",function(t){return e(t.v[stat])}).attr("cy",function(t){return a(t.v[stat])})}function addMarker(t,a){max=d3.max(chart_data,function(t){return t.v[stat]}),width=parseInt(d3.select("#line_chart").style("width"),10),height=parseInt(d3.select("#line_chart").style("height"),10);var e=d3.select("svg"),r=d3.scale.linear().range([margin.left,width-margin.right]).domain([chart_data[0].v[dd.chartNum],chart_data[chart_data.length-1].v[dd.chartNum]]),n=d3.scale.linear().range([height-margin.bottom,margin.top]).domain([0,max]),d=d3.scale.linear().range([2,8]).domain([0,max]),o=chart_data.length-parseInt(a)+1;e.append("circle").datum(chart_data[o]).attr("class","marker").attr("id","id_"+a).attr("r",function(t){return d(t.v[stat])}).attr("stroke-width",1).attr("stroke","#eee").attr("fill","rgba(238, 238, 238, 0.5)").attr("cx",function(){return r(a)}).attr("cy",function(){return n(t)})}function loadData(){var t="../data/data.json";d3.json(t,function(t,a){return t?console.warn(t):(data=a,renderTemplate(),void formatLineData())})}function renderTemplate(){$stat_button.eq(stat).addClass("selected"),$template_holder=$("#template_holder"),$template_holder.fadeOut("fast",function(){$(this).empty();var t=$("#template").html(),a=Mustache.render(t,data);$(this).html(a),$(this).fadeIn("slow"),$(".footer").fadeIn("slow"),bindData(),cloneHeader(),addEventHandlers()})}function bindData(){d3.selectAll(".container").data(data.vlogs).enter(),d3.selectAll(".container").select(".main-row").select(".vlog").html(function(t){return"S"+t.v[dd.season]+"<span class='episode'>V"+vlogFormat(t.v[dd.vlogNum])+"</span>"}),d3.selectAll(".container").select(".main-row").select(".city").html(function(t){return t.v[dd.city]}),d3.selectAll(".container").select(".main-row").select(".stat").html(function(t){return formatAbbrv(t.v[stat])}),d3.selectAll(".avg").html(formatAbbrv(data.avg[stat])),d3.select("#vlog-count-val").html(formatAbbrv(data.subs)),d3.selectAll(".last-updated-val").html(data.timestamp),d3.select("#stat-total").html(formatAbbrv(data.totals[stat])),d3.selectAll(".stat-name").html(statName[stat]),d3.select(".totals-label").html(statName[stat]),initScales(),initMarker(),initBar()}function initBar(){d3.selectAll(".main-row").select(".d1").style("width",function(t){return scale(t.v[stat])+"%"}).style("opacity",function(t){return oScale(t.v[stat])})}function initMarker(){d3.selectAll(".d2").style("width",scale(data.avg[stat])+"%")}function initScales(){max=d3.max(data.vlogs,function(t){return t.v[stat]}),scale=d3.scale.linear().domain([0,max]).range([0,97]),oScale=d3.scale.linear().domain([0,max]).range([.4,1])}function formatAbbrv(t){var a=formatSi(t);switch(a[a.length-1]){case"G":return a.slice(0,-1)+"B"}return a}function vlogFormat(t){return t>=100?t:t>=10&&t<100?"0"+t:t<10?"00"+t:t}function convertSeconds(t){var a=Math.floor(t/60),e=t%60;return e<10?a+":0"+e:a+":"+e}function convertSecondsToHours(t){var a=Math.floor(t/60),e=Math.floor(a/60),r=a%60;return r<10?e+":0"+r+":00":e+":"+r+":00"}function cloneHeader(){var t=$("#table > thead").clone(),a=$("#header-fixed").append(t);t.find("th.lock-icon > span").removeClass("fa-unlock-alt").addClass("fa-lock"),t.find("th.lock-icon").addClass("avoid-clicks"),setInterval(function(){var t=$(window).scrollTop();t>=tableOffset&&a.is(":hidden")?a.show():t<tableOffset&&a.hide()},100)}function toggleSortArrows(t){var a=t.find(".fa"),e=t.siblings(".sort").find(".fa");a.hasClass("fa-angle-down")||(e.removeClass("fa-angle-down"),e.addClass("fa-angle-up"),a.removeClass("fa-angle-up"),a.addClass("fa-angle-down"),sortData())}function sortData(){1===$sortIndex&&data.vlogs.sort(function(t,a){return a.v[dd.vlogID]-t.v[dd.vlogID]}),2===$sortIndex&&data.vlogs.sort(function(t,a){return d3.ascending(t.v[dd.city],a.v[dd.city])||t.v[dd.vlogID]-a.v[dd.ID]}),3===$sortIndex&&data.vlogs.sort(function(t,a){return a.v[stat]-t.v[stat]||t.v[dd.vlogID]-a.v[dd.vlogID]}),updateForSort()}function updateForSort(){$(".toggle-row").hide(),$(".toggle-icon").removeClass("td-selected");var t=d3.selectAll(".container").data(data.vlogs);t.exit().remove(),t.enter(),d3.selectAll(".container").select(".main-row").select(".d1").style("opacity",0).style("width",function(t){return scale(t.v[stat])+"%"}).transition().duration(1e3).style("opacity",function(t){return oScale(t.v[stat])}),d3.selectAll(".container").select(".main-row").select(".stat").style("opacity",0).html(function(t){return stat!==dd.duration?formatAbbrv(t.v[stat]):t.v[dd.hms]}).transition().duration(1e3).style("opacity",1),d3.selectAll(".container").select(".main-row").select(".vlog").style("opacity",0).html(function(t){return"S"+t.v[dd.season]+"<span class='episode'>V"+vlogFormat(t.v[dd.vlogNum])+"</span>"}).transition().duration(1e3).style("opacity",1),d3.selectAll(".container").select(".main-row").select(".city").style("opacity",0).html(function(t){return t.v[dd.city]}).transition().duration(1e3).style("opacity",1),d3.selectAll(".container").select(".main-row").select(".circle").style("opacity",0).classed("fa-square-o fa-check-square-o",!1).classed("fa-check-square-o",function(t){return selector_click_array.indexOf(t.v[dd.vlogID])>-1}).classed("fa-square-o",function(t){return selector_click_array.indexOf(t.v[dd.vlogID])===-1}).transition().duration(1e3).style("opacity",1),d3.selectAll(".container").select(".main-row").style("opacity",0).classed("selected-row",!1).classed("selected-row",function(t){return selector_click_array.indexOf(t.v[dd.vlogID])>-1}).transition().duration(1e3).style("opacity",1)}var max,scale,oScale,data,stat=0,stat_before=0,currentRoute="date-sort",format=d3.format("0,000"),parseDate=d3.time.format("%m/%d/%y").parse,formatDate=d3.time.format("%b %-d, %Y"),formatSi=d3.format(".3s"),lastIconIndex=-1,selector_click_array=[],download_data=[],selector_click_array_flag=!1,lineGen,area,careerLine,width,height,x,y,chart_data=[],$stat_button=$(".stat_button"),$sortIndex,tableOffset=185,statName=["VIEWS","LIKES","DISLIKES","DURATION"],margin={top:10,right:8,bottom:30,left:8},dd={views:0,likes:1,dislikes:2,duration:3,date:4,vlogNum:5,city:6,title:7,music:8,musicURL:9,url:10,hms:11,vlogID:12,season:13,chartNum:4,chartDate:5};$(window).resize(function(){resize()}),$(document).ready(function(){loadData()});